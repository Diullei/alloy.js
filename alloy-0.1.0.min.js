/* *****************************************************************************
	Alloy.JS 0.1.0
	A javascript library to dynamic binding.

	Copyright 2013 Diullei Gomes and other contributors
***************************************************************************** */

(function(){var k=/^<([-A-Za-z0-9_]+)((?:\s+[\w\-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,c=/^<\/([-A-Za-z0-9_]+)[^>]*>/,g=/([-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g;var f=b("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed");var a=b("address,applet,blockquote,button,center,dd,del,dir,div,dl,dt,fieldset,form,frameset,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,script,table,tbody,td,tfoot,th,thead,tr,ul");var i=b("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");var d=b("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");var j=b("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");var h=b("script,style");var e=this.HTMLParser=function(m,u){var p,q,n,r=[],s=m;r.last=function(){return this[this.length-1]};while(m){q=true;if(!r.last()||!h[r.last()]){if(m.indexOf("<!--")==0){p=m.indexOf("-->");if(p>=0){if(u.comment){u.comment(m.substring(4,p))}m=m.substring(p+3);q=false}}else{if(m.indexOf("</")==0){n=m.match(c);if(n){m=m.substring(n[0].length);n[0].replace(c,o);q=false}}else{if(m.indexOf("<")==0){n=m.match(k);if(n){m=m.substring(n[0].length);n[0].replace(k,l);q=false}}}}if(q){p=m.indexOf("<");var t=p<0?m:m.substring(0,p);m=p<0?"":m.substring(p);if(u.chars){u.chars(t)}}}else{m=m.replace(new RegExp("^((?:.|\n)*?)</"+r.last()+"[^>]*>"),function(v,w){w=w.replace(/<!--(.*?)-->/g,"$1").replace(/<!\[CDATA\[(.*?)]]>/g,"$1");if(u.chars){u.chars(w)}return""});o("",r.last())}if(m==s){throw"Parse Error: "+m}s=m}o();function l(v,y,z,w){y=y.toLowerCase();if(a[y]){while(r.last()&&i[r.last()]){o("",r.last())}}if(d[y]&&r.last()==y){o("",y)}w=f[y]||!!w;if(!w){r.push(y)}if(u.start){var x=[];z.replace(g,function(B,A){var C=arguments[2]?arguments[2]:arguments[3]?arguments[3]:arguments[4]?arguments[4]:j[A]?A:"";x.push({name:A,value:C,escaped:C.replace(/(^|[^\\])"/g,'$1\\"')})});if(u.start){u.start(y,x,w)}}}function o(v,x){if(!x){var y=0}else{for(var y=r.length-1;y>=0;y--){if(r[y]==x){break}}}if(y>=0){for(var w=r.length-1;w>=y;w--){if(u.end){u.end(r[w])}}r.length=y}}};function b(o){var n={},l=o.split(",");for(var m=0;m<l.length;m++){n[l[m]]=true}return n}})();(function(exports,$wnd,$doc){exports.$al=exports.AlloyJs={version:"0.1.0"};exports.AlloyJs.utils=(function(AlloyJs,$wnd,$doc){function Utils(){}Utils.prototype.isString=function(obj){return Object.prototype.toString.call(obj)=="[object String]"};Utils.prototype.isArray=function(obj){return Object.prototype.toString.call(obj)=="[object Array]"};Utils.prototype.isDate=function(obj){return Object.prototype.toString.call(obj)=="[object Date]"};Utils.prototype.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};Utils.prototype.evaluate=function(code,ctx){ctx=ctx||window;var result=null;eval("with (ctx) { result = "+code+" }");return result};return new Utils()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.oq=(function(AlloyJs,$wnd,$doc){function ObjectQuery(){}ObjectQuery.prototype.get=function(id,ctx){ctx=ctx||window;var ns=("ctx."+id).split(".");var obj=null;var tmp={ctx:ctx};for(var i=0;i<ns.length;i++){if(tmp[ns[i]]){tmp=tmp[ns[i]]}else{if(tmp[ns[i]]===null){tmp=tmp[ns[i]]}}}return tmp};return new ObjectQuery()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.hq=(function(AlloyJs,$wnd,$doc){function HtmlQuery(){}HtmlQuery.prototype.get=function(id){return document.getElementById(id)};HtmlQuery.prototype.getByAttribute=function(attribute){var matchingElements=[];var allElements=document.getElementsByTagName("*");for(var i=0;i<allElements.length;i++){if(allElements[i].getAttribute(attribute)!=null){matchingElements.push(allElements[i])}}return matchingElements};return new HtmlQuery()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.parser=(function(AlloyJs,$wnd,$doc){function Parser(){}Parser.prototype.exec=function(text,obj){var result={text:""};HTMLParser(text,{start:function(tag,attrs,unary){obj.start(result,tag,attrs,unary)},end:function(tag){obj.end(result,tag)},chars:function(text){obj.chars(result,text)},comment:function(text){obj.comment(result,text)}});return result};function parseContent(data,text){var pattern=/\{\{.+?\}\}/gi;var code=text.match(pattern);if(code){for(var i=0;i<code.length;i++){data.binds.push({type:"content",property:code[i].substr(2,code[i].length-4),html_id:AlloyJs.utils.guid()})}}}function parseAttributes(id,data,attrib,content){if(attrib=="data-al-bind"){data.binds.push({type:"al-bind",property:content.trim(),html_id:id});return true}return false}Parser.prototype.extractProperty=function(tmpl){AlloyJs.binds=[];var data={binds:[]};var parsedHtml=$al.parser.exec(tmpl,{start:function(out,tag,attrs,unary){var id=AlloyJs.utils.guid();var handled=false;out.text+="<"+tag;for(var i=0;i<attrs.length;i++){var flg=parseAttributes(id,data,attrs[i].name,attrs[i].escaped);if(flg){handled=flg}out.text+=" "+attrs[i].name+'="'+attrs[i].escaped+'"'}if(handled){out.text+=' id="_'+id+'"'}out.text+=(unary?"/":"")+">"},end:function(out,tag){out.text+="</"+tag+">"},chars:function(out,text){parseContent(data,text);out.text+=text},comment:function(out,text){out.text+="<!--"+text+"-->"}});AlloyJs.binds=data.binds;return parsedHtml.text};Parser.prototype.parseString=function(str){if(!$al.utils.isString(str)){return str}var tokens=[];var pattern=/\$\{.+?\}/gi;var code=str.match(pattern);if(code){for(var i=0;i<code.length;i++){var id=AlloyJs.utils.guid();tokens.push({token:code[i].substr(2,code[i].length-3),id:id});str=str.replace(code[i],id)}}return{str:str,tokens:tokens}};return new Parser()})(exports.AlloyJs,$wnd,$doc);function ArrayProxy(handler,original){var self=this;this.original=original;["push","pop","concat","every","filter","forEach","indexOf","join","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","slice","some","sort","splice","unshift","isArray"].forEach(function(fn){eval("self."+fn+" = function() { var value = self.original."+fn+".apply(self.original, arguments); handler(); return value; };")});self.getOriginal=function(){return self.original};Object.defineProperty(this,"length",{get:function(){return self.original.length},set:function(value){self.original.length=value}})}function StringProxy(handler,original){var self=this;this.original=original;["charAt","charCodeAt","concat","fromCharCode","indexOf","lastIndexOf","match","replace","search","slice","split","substr","substring","toLowerCase","toUpperCase","valueOf"].forEach(function(fn){eval("self."+fn+" = function() { var value = self.original."+fn+".apply(self.original, arguments); handler(); return value; };")});self.getOriginal=function(){return self.original};Object.defineProperty(this,"length",{get:function(){return self.original.length},set:function(value){self.original.length=value}})}function DateProxy(handler,original){var self=this;this.original=original;["getDate","getDay","getFullYear","getHours","getMilliseconds","getMinutes","getMonth","getSeconds","getTime","getTimezoneOffset","getUTCDate","getUTCDay","getUTCFullYear","getUTCHours","getUTCMilliseconds","getUTCMinutes","getUTCMonth","getUTCSeconds","parse","setDate","setFullYear","setHours","setMilliseconds","setMinutes","setMonth","setSeconds","setTime","setUTCDate","setUTCFullYear","setUTCHours","setUTCMinutes","setUTCMonth","setUTCSeconds","toDateString","setYear","toISOString","toJSON","toLocaleDateString","toLocaleTimeString","toLocaleString","toString","toTimeString","toUTCString","UTC","valueOf","valueOf"].forEach(function(fn){eval("self."+fn+" = function() { var value = self.original."+fn+".apply(self.original, arguments); handler(); return value; };")});self.getOriginal=function(){return self.original}}(function(exports,$al,$wnd,$doc){var cache={};function createProxy(expression,callback,oldObject,ctx){var newObject=oldObject;if($al.utils.isArray(oldObject)){eval("with (ctx) { newObject = new ArrayProxy(function(){callback("+expression+")}, oldObject); }")}else{if($al.utils.isString(oldObject)){eval("with (ctx) { newObject = new StringProxy(function(){callback("+expression+")}, oldObject); }")}else{if($al.utils.isDate(oldObject)){eval("with (ctx) { newObject = new DateProxy(function(){callback("+expression+")}, oldObject); }")}}}return newObject}function ObjectBinder(){}ObjectBinder.prototype.prop=function(id,getter,setter,ctx){ctx=ctx||$wnd;Object.defineProperty(ctx,id,{get:getter,set:setter,})};ObjectBinder.prototype.bind=function(id,getter,setter,ctx){var self=this,result=$al.oq.get(id),ns="ctx."+id,parts=ns.split("."),propObject=null,targetObject=null,isThisObj=false,strTargetObject="ctx",strPropObject="ctx",i;ctx=ctx||$wnd;targetObject=ctx;propObject=ctx;for(i=1;i<parts.length;i+=1){strPropObject=parts[i];if(i<parts.length-1){propObject=propObject[parts[i]];strTargetObject=parts[i]}if(i<parts.length-2){targetObject=targetObject[parts[i]]}}if(result!==undefined){if(propObject[strPropObject]!==undefined){if($al.utils.isArray(targetObject[strTargetObject])||$al.utils.isString(targetObject[strTargetObject])||$al.utils.isDate(targetObject[strTargetObject])){targetObject[strTargetObject]=createProxy(id,setter,targetObject[strTargetObject],ctx)}else{cache[strPropObject]=propObject[strPropObject];isThisObj=delete propObject[strPropObject];if(isThisObj){self.prop(strPropObject,function(){return getter(cache[strPropObject])||cache[strPropObject]},function(value){cache[strPropObject]=value;setter(value)},propObject)}}}else{throw new Error("can't bind undefined object")}}else{throw new Error("can't bind undefined object")}};exports.AlloyJs.ob=new ObjectBinder()}(exports,$al,$wnd,$doc));exports.AlloyJs.applyStr=function(str,ctx){var self=this;ctx=ctx||window;if(!this.utils.isString(str)){return str}var parsedStrResult=this.parser.parseString(str);if(parsedStrResult.tokens){if(parsedStrResult.tokens.length>0){var parsedStr=parsedStrResult.str;for(var i=0;i<parsedStrResult.tokens.length;i++){var token=parsedStrResult.tokens[i];eval('var val = self.utils.evaluate( "'+token.token+'", ctx) ');parsedStr=parsedStr.replace(token.id,val)}return parsedStr}}return str};var pubSub={cache:{},on:function(context,id,callback){if(!this.cache[context]){this.cache[context]={}}this.cache[context][id]=callback},trigger:function(context,id,value){if(this.cache[context]){var callback=this.cache[context][id];if(callback){callback(id,value)}}}};exports.AlloyJs.apply=function(el,ctx){var self=this;ctx=ctx||window;var html=el.innerHTML;html=self.parser.extractProperty(html);el.innerHTML=html;for(var i=0;i<self.binds.length;i++){var bind=self.binds[i];if(bind.type=="content"){html=html.replace(new RegExp("{{"+bind.property+"}}"),'<span id="_'+bind.html_id+'"></span>');eval('pubSub.on(ctx, bind.html_id, function(id, value){ var el = self.hq.get("_" + id); el.textContent = self.applyStr( self.utils.evaluate( "'+bind.property+'", ctx) ); el.innerText = self.applyStr( self.utils.evaluate( "'+bind.property+'", ctx) );  });')}}el.innerHTML=html;for(var i=0;i<self.binds.length;i++){var bind=self.binds[i];if(bind.type=="content"){var el=self.hq.get("_"+bind.html_id);eval('el.textContent = self.applyStr( self.utils.evaluate( "'+bind.property+'", ctx) )');eval('el.innerText = self.applyStr( self.utils.evaluate( "'+bind.property+'", ctx) )');eval('self.ob.bind("'+bind.property+'", function(value){ return value; }, function( value ){ pubSub.trigger(ctx, "'+bind.html_id+'", value); }, ctx );')}else{if(bind.type=="al-bind"){var el=self.hq.get("_"+bind.html_id);eval('el.addEventListener("change", function(){ with(ctx) {  '+bind.property+" = this.value; } });");eval('el.addEventListener("keydown", function(){ with(ctx) {  '+bind.property+" = this.value; } });");eval('el.addEventListener("keyup", function(){ with(ctx) {  '+bind.property+" = this.value; } });");eval('el.addEventListener("keypress", function(){ with(ctx) {  '+bind.property+" = this.value; } });")}}}};function init(){setTimeout(function(){var inits=$al.hq.getByAttribute("data-al-init");for(var i=0;i<inits.length;i++){var context=null;var attrValue=inits[i].getAttribute("data-al-init");if(attrValue){context=$al.oq.get(attrValue)}$al.apply(inits[i],context)}},50)}window.addEventListener("load",init,false)})(window,window,window.document);