/* *****************************************************************************
	Alloy.JS 0.1.0
	A javascript library to dynamic binding.

	Copyright 2013 Diullei Gomes and other contributors
***************************************************************************** */

(function(){var k=/^<([-A-Za-z0-9_]+)((?:\s+\w+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,c=/^<\/([-A-Za-z0-9_]+)[^>]*>/,g=/([-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g;var f=b("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed");var a=b("address,applet,blockquote,button,center,dd,del,dir,div,dl,dt,fieldset,form,frameset,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,script,table,tbody,td,tfoot,th,thead,tr,ul");var i=b("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");var d=b("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");var j=b("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");var h=b("script,style");var e=this.HTMLParser=function(m,u){var p,q,n,r=[],s=m;r.last=function(){return this[this.length-1]};while(m){q=true;if(!r.last()||!h[r.last()]){if(m.indexOf("<!--")==0){p=m.indexOf("-->");if(p>=0){if(u.comment){u.comment(m.substring(4,p))}m=m.substring(p+3);q=false}}else{if(m.indexOf("</")==0){n=m.match(c);if(n){m=m.substring(n[0].length);n[0].replace(c,o);q=false}}else{if(m.indexOf("<")==0){n=m.match(k);if(n){m=m.substring(n[0].length);n[0].replace(k,l);q=false}}}}if(q){p=m.indexOf("<");var t=p<0?m:m.substring(0,p);m=p<0?"":m.substring(p);if(u.chars){u.chars(t)}}}else{m=m.replace(new RegExp("(.*)</"+r.last()+"[^>]*>"),function(v,w){w=w.replace(/<!--(.*?)-->/g,"$1").replace(/<!\[CDATA\[(.*?)]]>/g,"$1");if(u.chars){u.chars(w)}return""});o("",r.last())}if(m==s){throw"Parse Error: "+m}s=m}o();function l(v,y,z,w){y=y.toLowerCase();if(a[y]){while(r.last()&&i[r.last()]){o("",r.last())}}if(d[y]&&r.last()==y){o("",y)}w=f[y]||!!w;if(!w){r.push(y)}if(u.start){var x=[];z.replace(g,function(B,A){var C=arguments[2]?arguments[2]:arguments[3]?arguments[3]:arguments[4]?arguments[4]:j[A]?A:"";x.push({name:A,value:C,escaped:C.replace(/(^|[^\\])"/g,'$1\\"')})});if(u.start){u.start(y,x,w)}}}function o(v,x){if(!x){var y=0}else{for(var y=r.length-1;y>=0;y--){if(r[y]==x){break}}}if(y>=0){for(var w=r.length-1;w>=y;w--){if(u.end){u.end(r[w])}}r.length=y}}};this.HTMLtoXML=function(m){var l="";e(m,{start:function(n,p,o){l+="<"+n;for(var q=0;q<p.length;q++){l+=" "+p[q].name+'="'+p[q].escaped+'"'}l+=(o?"/":"")+">"},end:function(n){l+="</"+n+">"},chars:function(n){l+=n},comment:function(n){l+="<!--"+n+"-->"}});return l};this.HTMLtoDOM=function(p,s){var o=b("html,head,body,title");var l={link:"head",base:"head"};if(!s){if(typeof DOMDocument!="undefined"){s=new DOMDocument()}else{if(typeof document!="undefined"&&document.implementation&&document.implementation.createDocument){s=document.implementation.createDocument("","",null)}else{if(typeof ActiveX!="undefined"){s=new ActiveXObject("Msxml.DOMDocument")}}}}else{s=s.ownerDocument||s.getOwnerDocument&&s.getOwnerDocument()||s}var m=[],r=s.documentElement||s.getDocumentElement&&s.getDocumentElement();if(!r&&s.createElement){(function(){var u=s.createElement("html");var t=s.createElement("head");t.appendChild(s.createElement("title"));u.appendChild(t);u.appendChild(s.createElement("body"));s.appendChild(u)})()}if(s.getElementsByTagName){for(var n in o){o[n]=s.getElementsByTagName(n)[0]}}var q=o.body;e(p,{start:function(w,v,u){if(o[w]){q=o[w];if(!u){m.push(q)}return}var x=s.createElement(w);for(var t in v){x.setAttribute(v[t].name,v[t].value)}if(l[w]&&typeof o[l[w]]!="boolean"){o[l[w]].appendChild(x)}else{if(q&&q.appendChild){q.appendChild(x)}}if(!u){m.push(x);q=x}},end:function(t){m.length-=1;q=m[m.length-1]},chars:function(t){q.appendChild(s.createTextNode(t))},comment:function(t){}});return s};function b(o){var n={},l=o.split(",");for(var m=0;m<l.length;m++){n[l[m]]=true}return n}})();(function(exports,$wnd,$doc){exports.$al=exports.AlloyJs={version:"0.1.0"};exports.AlloyJs.utils=(function(AlloyJs,$wnd,$doc){function Utils(){}Utils.prototype.isString=function(obj){var toString=Object.prototype.toString;return toString.call(obj)=="[object String]"};Utils.prototype.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)})};Utils.prototype.evaluate=function(code,ctx){ctx=ctx||window;var result=null;eval("with (ctx) { result = "+code+" }");return result};return new Utils()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.oq=(function(AlloyJs,$wnd,$doc){function ObjectQuery(){}ObjectQuery.prototype.get=function(id,ctx){ctx=ctx||window;var ns=("ctx."+id).split(".");var obj=null;var tmp={ctx:ctx};for(var i=0;i<ns.length;i++){if(tmp[ns[i]]){tmp=tmp[ns[i]]}else{if(tmp[ns[i]]===null){tmp=tmp[ns[i]]}}}return tmp};return new ObjectQuery()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.hq=(function(AlloyJs,$wnd,$doc){function HtmlQuery(){}HtmlQuery.prototype.get=function(id){return document.getElementById(id)};HtmlQuery.prototype.getByAttribute=function(attribute){var matchingElements=[];var allElements=document.getElementsByTagName("*");for(var i=0;i<allElements.length;i++){if(allElements[i].getAttribute(attribute)!=null){matchingElements.push(allElements[i])}}return matchingElements};return new HtmlQuery()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.parser=(function(AlloyJs,$wnd,$doc){function Parser(){}Parser.prototype.exec=function(text,obj){var result={text:""};HTMLParser(text,{start:function(tag,attrs,unary){obj.start(result,tag,attrs,unary)},end:function(tag){obj.end(result,tag)},chars:function(text){obj.chars(result,text)},comment:function(text){obj.comment(result,text)}});return result};Parser.prototype.extractProperty=function(tmpl){AlloyJs.binds=[];var pattern=/\{\{.+?\}\}/gi;var code=tmpl.match(pattern);if(code){for(var i=0;i<code.length;i++){AlloyJs.binds.push({property:code[i].substr(2,code[i].length-4),html_id:AlloyJs.utils.guid()})}}};Parser.prototype.parseString=function(str){if(!$al.utils.isString(str)){return str}var tokens=[];var pattern=/\$\{.+?\}/gi;var code=str.match(pattern);if(code){for(var i=0;i<code.length;i++){var id=AlloyJs.utils.guid();tokens.push({token:code[i].substr(2,code[i].length-3),id:id});str=str.replace(code[i],id)}}return{str:str,tokens:tokens}};return new Parser()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.ob=(function(AlloyJs,$wnd,$doc){function ObjectBinder(){}var cache={};ObjectBinder.prototype.prop=function(id,getter,setter,ctx){ctx=ctx||window;Object.defineProperty(ctx,id,{get:getter,set:setter})};ObjectBinder.prototype.bind=function(id,getter,setter,ctx){var self=this;ctx=ctx||window;var result=$al.oq.get(id);if(result!==undefined){var parts=("ctx."+id).split(".");var target=("ctx."+id).substr(0,("ctx."+id).lastIndexOf("."));var prop=parts[parts.length-1];if(target+"."+prop){eval("cache[prop] = "+target+"."+prop);var isThisObj=false;eval("isThisObj = delete "+target+"."+prop);if(isThisObj){var codeGetterSetter='self.prop("'+prop+'", function() { return getter(cache[prop]) || cache[prop]; }, function(__value){ cache[prop] = __value; setter(__value); }, '+target+")";eval(codeGetterSetter)}else{}}else{throw new Error("can't bind undefined object")}}else{throw new Error("can't bind undefined object")}};return new ObjectBinder()})(exports.AlloyJs,$wnd,$doc);exports.AlloyJs.applyStr=function(str,ctx){var self=this;ctx=ctx||window;var parsedStrResult=this.parser.parseString(str);if(parsedStrResult.tokens){if(parsedStrResult.tokens.length>0){var parsedStr=parsedStrResult.str;for(var i=0;i<parsedStrResult.tokens.length;i++){var token=parsedStrResult.tokens[i];console.log('var val = self.utils.evaluate( "'+token.token+'", ctx) ');eval('var val = self.utils.evaluate( "'+token.token+'", ctx) ');parsedStr=parsedStr.replace(token.id,val)}return parsedStr}}return str};exports.AlloyJs.apply=function(el,ctx){var self=this;ctx=ctx||window;var html=el.innerHTML;self.parser.extractProperty(html);for(var i=0;i<self.binds.length;i++){var bind=self.binds[i];html=html.replace(new RegExp("{{"+bind.property+"}}"),'<span id="_'+bind.html_id+'"></span>')}el.innerHTML=html;for(var i=0;i<self.binds.length;i++){var bind=self.binds[i];var el=self.hq.get("_"+bind.html_id);eval('el.textContent = self.applyStr( self.utils.evaluate( "'+bind.property+'", ctx) )');eval('el.innerText = self.applyStr( self.utils.evaluate( "'+bind.property+'", ctx) )');eval('self.ob.bind("'+bind.property+'", function(value){ return value; }, function( value ){ var el = self.hq.get("_'+bind.html_id+'"); el.textContent = self.applyStr(value); el.innerText = self.applyStr(value); }, ctx );')}};function init(){var inits=$al.hq.getByAttribute("data-al-init");for(var i=0;i<inits.length;i++){$al.apply(inits[i])}}window.addEventListener("load",init,false)})(window,window.document);